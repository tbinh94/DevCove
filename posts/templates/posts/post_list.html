{% extends 'posts/base.html' %}
{% load static %}

{% block content %}
<div class="main-container">
  <!-- Left sidebar -->
  <div class="sidebar">
    <!-- Search -->
    <div class="search-section">
      <form method="GET" class="search-form">
        <input type="text" name="q" value="{{ search_query }}" placeholder="Search posts..." class="search-input">
        <button type="submit" class="search-btn">üîç</button>
      </form>
    </div>

    <!-- Tags -->
    <div class="tags-section">
      <h3>Popular Tags</h3>
      <div class="tags-list">
        {% for tag in popular_tags %}
          <a href="?tag={{ tag.slug }}" class="tag-badge {% if current_tag == tag.slug %}active{% endif %}"
             style="background-color: {{ tag.color }};">
            {{ tag.name }}
            <span class="tag-count">{{ tag.post_count }}</span>
          </a>
        {% endfor %}
        <a href="{% url 'posts:all_tags' %}" class="view-all-tags">View all tags ‚Üí</a>
      </div>
    </div>

    <!-- Filters -->
    {% if current_tag or search_query %}
    <div class="filter-status">
      <h4>Active Filters:</h4>
      {% if current_tag %}
        <div class="filter-item">
          Tag: <span class="filter-value">{{ current_tag }}</span>
          <a href="{% url 'posts:post_list' %}" class="clear-filter">√ó</a>
        </div>
      {% endif %}
      {% if search_query %}
        <div class="filter-item">
          Search: <span class="filter-value">{{ search_query }}</span>
          <a href="{% url 'posts:post_list' %}" class="clear-filter">√ó</a>
        </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Main content -->
  <div class="main-content">
    <!-- Create Post -->
    {% if user.is_authenticated %}
    <div class="create-post-section">
      <div class="create-post-card">
        <div class="user-avatar"><span class="avatar-icon">üë§</span></div>
        <div class="create-post-input">
          <input type="text" placeholder="Create Post" readonly onclick="window.location.href='{% url 'posts:create_post' %}'">
        </div>
        <div class="create-post-actions">
          <a href="{% url 'posts:create_post' %}" class="create-btn"><span class="icon">üìù</span></a>
          <a href="{% url 'posts:create_post' %}" class="create-btn"><span class="icon">üì∑</span></a>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Posts -->
    <div class="posts-container">
      {% for post in posts %}
        <div class="post-card">
          <div class="vote-section">
            <button class="vote-btn upvote" data-id="{{ post.id }}" data-dir="up">
              <span class="vote-arrow">‚ñ≤</span>
            </button>
            <div class="score" id="score-{{ post.id }}">{{ post.score }}</div>
            <button class="vote-btn downvote" data-id="{{ post.id }}" data-dir="down">
              <span class="vote-arrow">‚ñº</span>
            </button>
          </div>

          <div class="post-body">
            <div class="post-meta">
              {% if post.community %}
                <a href="{% url 'posts:community' post.community.slug %}" class="community-badge">r/{{ post.community.slug }}</a>
                <span class="separator">‚Ä¢</span>
              {% endif %}
              <span class="author">u/{{ post.author.username }}</span>
              <span class="separator">‚Ä¢</span>
              <span class="time">{{ post.created_at|timesince }} ago</span>
            </div>
            
            <h3 class="post-title">
              <a href="{% url 'posts:post_detail' post.id %}">{{ post.title }}</a>
            </h3>
            
            {% if post.tags.exists %}
              <div class="post-tags">
                {% for tag in post.tags.all %}
                  <a href="?tag={{ tag.slug }}" class="tag-badge small" style="background-color: {{ tag.color }};">{{ tag.name }}</a>
                {% endfor %}
              </div>
            {% endif %}
            
            {% if post.content %}
              <div class="post-content">{{ post.content|truncatewords:20 }}</div>
            {% endif %}
            {% if post.image %}
              <div class="post-image">
                <img src="{{ post.image.url }}" alt="Post image">
              </div>
            {% endif %}
            
            <div class="post-actions">
              <a href="{% url 'posts:post_detail' post.id %}" class="action-btn">
                <span class="icon">üí¨</span>{{ post.comment_count }}
              </a>
              <button class="action-btn"><span class="icon">üîó</span>Share</button>
              <button class="action-btn"><span class="icon">üîñ</span>Save</button>
              {% if post.author == user %}
                <a href="{% url 'posts:edit_post' post.id %}" class="action-btn edit-btn">
                  <span class="icon">‚úèÔ∏è</span>Edit
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% empty %}
        <div class="empty-state">
          <div class="empty-icon">üìù</div>
          <h3>No posts yet</h3>
          <p>Be the first to create a post!</p>
          {% if user.is_authenticated %}
            <a href="{% url 'posts:create_post' %}" class="btn">Create Post</a>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if posts.has_other_pages %}
    <div class="pagination">
      {% if posts.has_previous %}
        <a href="?page={{ posts.previous_page_number }}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn">‚Üê Previous</a>
      {% endif %}
      <span class="page-info">Page {{ posts.number }} of {{ posts.paginator.num_pages }}</span>
      {% if posts.has_next %}
        <a href="?page={{ posts.next_page_number }}{% if current_tag %}&tag={{ current_tag }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-btn">Next ‚Üí</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<style>
/* Base */
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#dae0e6;color:#1a1a1b;line-height:1.4}

/* Layout */
.main-container{display:flex;max-width:1200px;margin:0 auto;padding:20px;gap:24px;min-height:100vh;align-items:flex-start}
.sidebar{width:280px;min-width:240px;flex:0 1 280px;position:sticky;top:20px;height:fit-content;max-height:calc(100vh - 40px);overflow-y:auto}
.main-content{flex:1 1 auto;min-width:0;width:100%}

/* Search */
.search-section{background:#fff;border:1px solid #ccc;border-radius:4px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.search-form{display:flex;gap:8px}
.search-input{flex:1;padding:10px 12px;border:1px solid #edeff1;border-radius:4px;font-size:14px;background:#f6f7f8;color:#1a1a1b;transition:all .2s}
.search-input:focus{outline:none;border-color:#0079d3;background:#fff;box-shadow:0 0 0 1px #0079d3}
.search-btn{padding:10px 16px;background:#0079d3;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:600;transition:background .2s}
.search-btn:hover{background:#0066cc}

/* Tags */
.tags-section{background:#fff;border:1px solid #ccc;border-radius:4px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.tags-section h3{margin:0 0 12px 0;font-size:16px;font-weight:600}
.tags-list{display:flex;flex-direction:column;gap:8px}
.tag-badge{display:inline-flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#0079d3;color:#fff;text-decoration:none;border-radius:20px;font-size:12px;font-weight:500;transition:all .2s}
.tag-badge:hover{background:#0066cc;text-decoration:none;color:#fff;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,.1)}
.tag-badge.active{background:#0066cc;box-shadow:0 0 0 2px #0079d3}
.tag-badge.small{padding:4px 8px;font-size:11px;margin-right:4px;margin-bottom:4px;border-radius:12px}
.tag-count{background:rgba(255,255,255,.25);padding:2px 6px;border-radius:10px;font-size:10px;margin-left:8px;font-weight:600}
.post-tags{margin:8px 0;display:flex;flex-wrap:wrap}
.view-all-tags{color:#0079d3;font-size:12px;text-decoration:none;margin-top:8px;display:block;font-weight:500;text-align:center;padding:8px;border-radius:4px;transition:background .2s}
.view-all-tags:hover{background:#f6f7f8;text-decoration:none}

/* Filters */
.filter-status{background:#fff;border:1px solid #ccc;border-radius:4px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.filter-status h4{margin:0 0 8px 0;font-size:14px;color:#7c7c83;font-weight:600}
.filter-item{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px;flex-wrap:wrap}
.filter-value{background:#0079d3;color:#fff;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:500}
.clear-filter{color:#dc3545;text-decoration:none;font-weight:bold;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:#f8d7da;font-size:14px;transition:all .2s}
.clear-filter:hover{background:#dc3545;color:#fff}

/* Create Post */
.create-post-section{margin-bottom:16px}
.create-post-card{background:#fff;border:1px solid #ccc;border-radius:4px;padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:box-shadow .2s}
.create-post-card:hover{box-shadow:0 2px 6px rgba(0,0,0,.15)}
.user-avatar{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f6f7f8,#e9ecef);border-radius:50%;border:2px solid #edeff1}
.avatar-icon{font-size:20px;color:#787c7e}
.create-post-input{flex:1;min-width:0}
.create-post-input input{width:100%;padding:12px 16px;border:1px solid #edeff1;border-radius:20px;background:#f6f7f8;cursor:pointer;font-size:14px;color:#787c7e;transition:all .2s}
.create-post-input input:hover{border-color:#0079d3;background:#fff;box-shadow:0 0 0 1px #0079d3}
.create-post-actions{display:flex;gap:8px}
.create-btn{padding:8px 12px;background:none;border:1px solid #edeff1;cursor:pointer;border-radius:4px;text-decoration:none;color:#787c7e;transition:all .2s;display:flex;align-items:center;justify-content:center}
.create-btn:hover{background:#f6f7f8;color:#1a1a1b;border-color:#ccc;transform:translateY(-1px)}

/* Posts */
.posts-container{background:#fff;border:1px solid #ccc;border-radius:4px;overflow:hidden;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.post-card{display:flex;padding:10px;border-bottom:1px solid #f6f7f8;background:#fff;transition:all .2s;position:relative}
.post-card:hover{background:#f8f9fa}
.post-card:last-child{border-bottom:none}
.post-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#0079d3;opacity:0;transition:opacity .2s}
.post-card:hover::before{opacity:1}

/* Vote */
.vote-section{display:flex;flex-direction:column;align-items:center;width:40px;margin-right:12px;padding-top:4px}
.vote-btn{background:none;border:none;cursor:pointer;padding:6px;color:#878a8c;border-radius:2px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.vote-btn:hover{background:#f6f7f8;color:#1a1a1b}
.vote-btn.upvote:hover{background:#ffeaa7;color:#ff6b35}
.vote-btn.downvote:hover{background:#ffeaa7;color:#ff6b35}
.vote-btn.voted-up,.vote-btn.voted-down{background:#ff6b35!important;color:#fff!important}
.vote-btn.voted-up:hover,.vote-btn.voted-down:hover{background:#ff5722!important;color:#fff!important}
.vote-arrow{font-size:16px;font-weight:bold}
.score{font-size:12px;font-weight:700;color:#1a1a1b;margin:4px 0;text-align:center;padding:2px 4px;border-radius:4px;transition:color .2s}
.score.voted{color:#ff6b35;font-weight:bold}

/* Post Content */
.post-body{flex:1;min-width:0;overflow-wrap:break-word}
.post-meta{font-size:12px;color:#787c7e;margin-bottom:8px;display:flex;align-items:center;flex-wrap:wrap;gap:4px}
.community-badge{color:#1a1a1b;font-weight:700;text-decoration:none;padding:2px 4px;border-radius:3px;transition:background .2s}
.community-badge:hover{background:#f6f7f8;text-decoration:none}
.separator{margin:0 6px;color:#ccc}
.author,.time{color:#787c7e;white-space:nowrap}
.post-title{margin:0 0 10px 0;font-size:18px;font-weight:500;line-height:1.3}
.post-title a{color:#1a1a1b;text-decoration:none;transition:color .2s}
.post-title a:hover{color:#0079d3}
.post-content{font-size:14px;color:#1a1a1b;margin-bottom:10px;line-height:1.5}
.post-image{margin:10px 0;border-radius:4px;overflow:hidden;max-width:100%}
.post-image img{max-width:100%;max-height:400px;object-fit:cover;display:block;transition:transform .2s}
.post-image:hover img{transform:scale(1.02)}

/* Actions */
.post-actions{display:flex;gap:4px;margin-top:10px;flex-wrap:wrap}
.action-btn{background:none;border:none;color:#878a8c;font-size:12px;cursor:pointer;padding:6px 8px;border-radius:2px;text-decoration:none;display:flex;align-items:center;gap:4px;font-weight:700;transition:all .2s}
.action-btn:hover{background:#f6f7f8;color:#1a1a1b;text-decoration:none}
.action-btn .icon{font-size:12px}
.edit-btn:hover{color:#46d160;background:#e8f5e8}

/* Pagination */
.pagination{display:flex;align-items:center;justify-content:center;gap:20px;margin-top:20px;padding:20px 0;flex-wrap:wrap}
.page-btn{padding:10px 20px;background:#0079d3;color:#fff;text-decoration:none;border-radius:20px;font-size:14px;font-weight:600;transition:all .2s;box-shadow:0 2px 4px rgba(0,121,211,.3)}
.page-btn:hover{background:#0066cc;color:#fff;text-decoration:none;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,121,211,.4)}
.page-info{color:#787c7e;font-size:14px;font-weight:500}

/* Empty State */
.empty-state{text-align:center;padding:80px 20px;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.empty-icon{font-size:72px;margin-bottom:20px;opacity:.6}
.empty-state h3{color:#1a1a1b;margin-bottom:10px;font-size:24px;font-weight:600}
.empty-state p{color:#787c7e;margin-bottom:24px;font-size:16px}
.btn{padding:12px 24px;background:#0079d3;color:#fff;text-decoration:none;border-radius:20px;font-size:14px;font-weight:600;display:inline-block;transition:all .2s;box-shadow:0 2px 4px rgba(0,121,211,.3)}
.btn:hover{background:#0066cc;text-decoration:none;color:#fff;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,121,211,.4)}

/* Responsive */
@media (max-width:900px){
  .main-container{flex-direction:column;padding:12px;gap:12px}
  .sidebar{width:100%;min-width:auto;max-width:none;order:2;position:static;max-height:none;overflow-y:visible}
  .main-content{order:1;width:100%}
  .post-meta{font-size:11px}
  .separator{margin:0 4px}
}

@media (max-width:768px){
  .post-card{padding:12px 8px}
  .vote-section{width:36px;margin-right:8px}
  .post-title{font-size:16px}
  .post-content{font-size:13px}
  .create-post-input input{padding:10px 14px;font-size:13px}
  .user-avatar{width:32px;height:32px}
  .avatar-icon{font-size:16px}
  .create-post-actions{gap:6px}
}

@media (max-width:480px){
  .main-container{padding:8px}
  .post-card{padding:8px}
  .create-post-card{padding:8px 12px;gap:8px}
  .post-title{font-size:15px}
  .vote-section{width:32px;margin-right:6px}
  .vote-btn{width:24px;height:24px;padding:4px}
  .vote-arrow{font-size:12px}
  .score{font-size:11px}
  .post-meta{flex-direction:column;align-items:flex-start;gap:2px}
  .post-meta .separator{display:none}
  .action-btn{padding:4px 6px;font-size:11px}
}

/* Scrollbar */
.sidebar::-webkit-scrollbar{width:6px}
.sidebar::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px}
.sidebar::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}
.sidebar::-webkit-scrollbar-thumb:hover{background:#a8a8a8}

/* Focus */
.search-input:focus,.create-post-input input:focus{outline:2px solid #0079d3;outline-offset:2px}
.vote-btn:focus,.action-btn:focus,.tag-badge:focus,.page-btn:focus,.btn:focus{outline:2px solid #0079d3;outline-offset:2px}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
window.voteConfig = {
  isAuthenticated: {{ request.user.is_authenticated|yesno:"true,false" }},
  loginUrl: "{% url 'login' %}?next={{ request.get_full_path|urlencode }}",
  voteUrl: "{% url 'posts:vote' %}"
};
</script>
<script src="{% static 'posts/js/vote.js' %}"></script>
{% endblock %}